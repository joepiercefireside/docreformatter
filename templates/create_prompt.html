{% extends "base.html" %}
{% block title %}Create Prompts{% endblock %}
{% block content %}
<div class="card shadow-sm">
    <div class="card-body">
        <h1 class="card-title mb-4">Create/Edit Prompts</h1>
        <form method="GET" action="{{ url_for('create_prompt') }}">
            <div class="form-group">
                <label for="client_id">Select Client:</label>
                <select class="form-control" id="client_id" name="client_id" onchange="this.form.submit()">
                    <option value="">Global (All Clients)</option>
                    {% for client in clients %}
                        <option value="{{ client }}" {% if client == selected_client %}selected{% endif %}>{{ client }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
        <h3>{% if selected_client %}Prompts for {{ selected_client }}{% else %}Global Prompts{% endif %}</h3>
        {% if prompts %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Prompt Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prompt in prompts %}
                        <tr>
                            <td>{{ prompt.prompt_name }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editPrompt('{{ prompt.prompt_name | safe }}', '{{ prompt.prompt_content | safe }}')">Edit</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No prompts found for {% if selected_client %}{{ selected_client }}{% else %}global use{% endif %}.</p>
        {% endif %}
        <h3 id="form-title">{% if selected_prompt %}Edit Prompt{% else %}Create New Prompt{% endif %}</h3>
        <form method="POST" id="prompt-form">
            <input type="hidden" name="action" id="action" value="create">
            <input type="hidden" name="client_id" value="{{ selected_client }}">
            <div class="form-group">
                <label for="prompt_name">Prompt Name:</label>
                <input type="text" class="form-control" id="prompt_name" name="prompt_name" required>
            </div>
            <div class="form-group">
                <label for="prompt_content">Prompt Content:</label>
                <textarea class="form-control" id="prompt_content" name="prompt_content" rows="5" required></textarea>
            </div>
            <div id="create-button" style="display: block;">
                <button type="submit" class="btn btn-primary">Create Prompt</button>
            </div>
            <div id="edit-buttons" style="display: none;">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            </div>
        </form>
    </div>
</div>
<script>
function editPrompt(promptName, promptContent) {
    document.getElementById('prompt_name').value = promptName;
    document.getElementById('prompt_content').value = promptContent;
    document.getElementById('action').value = 'update';
    document.getElementById('form-title').textContent = 'Edit Prompt';
    document.getElementById('create-button').style.display = 'none';
    document.getElementById('edit-buttons').style.display = 'block';
}

function cancelEdit() {
    document.getElementById('prompt_form').reset();
    document.getElementById('action').value = 'create';
    document.getElementById('form-title').textContent = 'Create New Prompt';
    document.getElementById('create-button').style.display = 'block';
    document.getElementById('edit-buttons').style.display = 'none';
}

// Client-side validation to warn about potential duplicates
document.getElementById('prompt-form').addEventListener('submit', function(event) {
    var promptName = document.getElementById('prompt_name').value.trim();
    var existingPrompts = [
        {% for prompt in prompts %}
            '{{ prompt.prompt_name | safe }}',
        {% endfor %}
    ];
    var action = document.getElementById('action').value;
    if (action === 'create' && existingPrompts.includes(promptName)) {
        alert('A prompt with this name already exists for this client. Please choose a different name.');
        event.preventDefault();
    }
});
</script>
{% endblock %}