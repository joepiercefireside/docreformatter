<!DOCTYPE html>
{% extends "base.html" %}
{% block title %}Create Templates{% endblock %}
{% block content %}
<div class="card shadow-sm">
    <div class="card-body">
        <h1 class="card-title mb-4">Create/Edit Templates</h1>
        <form method="GET" action="{{ url_for('create_template') }}">
            <div class="form-group">
                <label for="client_id">Select Client:</label>
                <select class="form-control" id="client_id" name="client_id" onchange="this.form.submit()">
                    <option value="">Global (All Clients)</option>
                    {% for client in clients %}
                        <option value="{{ client }}" {% if client == selected_client %}selected{% endif %}>{{ client }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
        <h3>{% if selected_client %}Templates for {{ selected_client }}{% else %}Global Templates{% endif %}</h3>
        {% if templates %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Template Name</th>
                        <th>Associated Prompt</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for template in templates %}
                        <tr>
                            <td>{{ template.template_name }}</td>
                            <td>{{ template.prompt_name }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editTemplate('{{ template.template_name }}', '{{ template.prompt_name }}')">Edit</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No templates found for {% if selected_client %}{{ selected_client }}{% else %}global use{% endif %}.</p>
        {% endif %}
        <h3>{% if selected_template %}Edit Template{% else %}Create New Template{% endif %}</h3>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="{% if selected_template %}update{% else %}create{% endif %}">
            <input type="hidden" name="client_id" value="{{ selected_client }}">
            <div class="form-group">
                <label for="template_name">Template Name:</label>
                <input type="text" class="form-control" id="template_name" name="template_name" value="{{ selected_template or '' }}" required>
            </div>
            <div class="form-group">
                <label for="prompt_name">Select Existing Prompt:</label>
                <select class="form-control" id="prompt_name" name="prompt_name" onchange="loadPromptContentForTemplate()">
                    <option value="">Create a new prompt below</option>
                    {% for prompt in prompts %}
                        <option value="{{ prompt.prompt_name }}" {% if prompt.prompt_name == selected_prompt %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="prompt_content">New Prompt Content (if not selecting existing):</label>
                <textarea class="form-control" id="prompt_content" name="prompt_content" rows="5"></textarea>
                <small class="form-text text-muted">Required if not selecting an existing prompt.</small>
            </div>
            <div class="form-group">
                <label for="prompt_name_new">New Prompt Name (if creating new):</label>
                <input type="text" class="form-control" id="prompt_name_new" name="prompt_name_new">
                <small class="form-text text-muted">Required if creating a new prompt.</small>
            </div>
            <div class="form-group">
                <label for="template_file">Upload Template (.docx):</label>
                <input type="file" class="form-control-file" id="template_file" name="template_file" accept=".docx" {% if not selected_template %}required{% endif %}>
                <small class="form-text text-muted">Optional when editing an existing template.</small>
            </div>
            <button type="submit" class="btn btn-primary">{% if selected_template %}Update Template{% else %}Create Template{% endif %}</button>
        </form>
    </div>
</div>
<script>
function editTemplate(templateName, promptName) {
    document.getElementById('template_name').value = templateName;
    document.getElementById('prompt_name').value = promptName;
    document.querySelector('input[name="action"]').value = 'update';
    loadPromptContentForTemplate();
}

function loadPromptContentForTemplate() {
    var clientId = document.querySelector('input[name="client_id"]').value;
    var promptName = document.getElementById('prompt_name').value;
    
    if (promptName && clientId) {
        $.ajax({
            url: '/load_client',
            type: 'POST',
            data: {
                client_id: clientId,
                prompt_name: promptName
            },
            success: function(response) {
                if (response.prompt) {
                    document.getElementById('prompt_content').value = response.prompt;
                } else {
                    document.getElementById('prompt_content').value = '';
                }
            },
            error: function() {
                document.getElementById('prompt_content').value = '';
            }
        });
    } else {
        document.getElementById('prompt_content').value = '';
    }
}
</script>
{% endblock %}