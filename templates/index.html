<!DOCTYPE html>
<html>
<head>
    <title>Diligent Document Reformatter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <img src="{{ url_for('static', filename='images/diligent_logo.png') }}" alt="Diligent Logo" class="logo">
            <h1>Diligent Document Reformatter</h1>
            <nav>
                <a href="{{ url_for('create_client') }}">Create Client</a> |
                <a href="{{ url_for('create_prompt') }}">Create Prompt</a> |
                <a href="{{ url_for('create_template') }}">Create Template</a> |
                <a href="{{ url_for('logout') }}">Logout</a>
            </nav>
        </header>
        <main>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="action" value="select_client">
                <label for="client">Select Client:</label>
                <select id="client" name="client">
                    <option value="">Select Client</option>
                    {% for client in clients %}
                        <option value="{{ client }}" {% if client == selected_client %}selected{% endif %}>{{ client }}</option>
                    {% endfor %}
                </select>
                <br>
                <label for="template">Select Template:</label>
                <select id="template" name="template">
                    <option value="">Select Template</option>
                    {% for template in templates %}
                        <option value="{{ template.template_name }}" {% if template.template_name == selected_template %}selected{% endif %}>{{ template.template_name }}</option>
                    {% endfor %}
                </select>
                <br>
                <label for="prompt_name">Select Prompt:</label>
                <select id="prompt_name" name="prompt_name">
                    <option value="Custom" {% if selected_prompt == 'Custom' %}selected{% endif %}>Custom</option>
                    {% for prompt in prompts %}
                        <option value="{{ prompt.prompt_name }}" {% if prompt.prompt_name == selected_prompt %}selected{% endif %}>{{ prompt.prompt_name }}</option>
                    {% endfor %}
                </select>
                <br>
                <label for="ai_prompt">AI Prompt:</label>
                <textarea id="ai_prompt" name="ai_prompt" rows="10" cols="50">{{ prompt_content }}</textarea>
                <br>
                <label for="source_file">Upload Document:</label>
                <input type="file" id="source_file" name="source_file" accept=".docx">
                <br>
                <input type="submit" value="Reformat Document" onclick="this.form.action.value='upload_document';">
            </form>
        </main>
    </div>
    <script>
        $(document).ready(function() {
            $('#client').change(function() {
                var clientId = $(this).val();
                $.post('/load_client', { client: clientId }, function(data) {
                    $('#template').empty().append('<option value="">Select Template</option>');
                    $.each(data.templates, function(i, template) {
                        $('#template').append('<option value="' + template.template_name + '">' + template.template_name + '</option>');
                    });
                    $('#prompt_name').empty().append('<option value="Custom">Custom</option>');
                    $.each(data.prompts, function(i, prompt) {
                        $('#prompt_name').append('<option value="' + prompt.prompt_name + '">' + prompt.prompt_name + '</option>');
                    });
                    $('#ai_prompt').val('');
                });
            });

            $('#template').change(function() {
                var clientId = $('#client').val();
                var templateName = $(this).val();
                if (clientId && templateName) {
                    $.post('/', { client: clientId, template: templateName }, function(data) {
                        $('#prompt_name').val(data.prompt_name || 'Custom');
                        $('#ai_prompt').val(data.prompt_content || '');
                    });
                }
            });

            $('#prompt_name').change(function() {
                var promptName = $(this).val();
                var clientId = $('#client').val();
                if (clientId && promptName && promptName != 'Custom') {
                    $.post('/load_client', { client: clientId, prompt_name: promptName }, function(data) {
                        $('#ai_prompt').val(data.prompt_content || '');
                    });
                } else {
                    $('#ai_prompt').val('');
                }
            });
        });
    </script>
</body>
</html>